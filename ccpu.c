/* A kind of a minimal C-like CPU, including assembler and emulator with RGB222 video */
/* Compilation: gcc ccpu8.c -o ccpu -lSDL2main -lSDL2 */

#include <stdio.h>
#include <SDL2/SDL.h>

//#define DEBUG

#define JMP  0 /* goto addr;               */
#define JML  1 /* if(reg1<reg2) goto addr; */
#define MOV  2 /* reg = val;               */
#define LDA  3 /* reg1 = mem[reg2];        */
#define STO  4 /* mem[reg1] = reg2;        */
#define SHL  5 /* reg1 = reg2 << reg3;     */
#define SHR  6 /* reg1 = reg2 >> reg3;     */
#define NOT  7 /* reg1 = ~reg2             */
#define AND  8 /* reg1 = reg2 & reg3;      */
#define IOR  9 /* reg1 = reg2 | reg3;      */
#define XOR 10 /* reg1 = reg2 ^ reg3;      */
#define ADD 11 /* reg1 = reg2 + reg3;      */
#define MUL 12 /* reg1 = reg2 * reg3;      */
#define DIV 13 /* reg1 = reg2 / reg3;      */
#define MOD 14 /* reg1 = reg2 % reg3;      */

/* monochrome 8x8 ASCII font */
char ASCII[6080] = {0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,1,1,0,1,1,0,0,0,1,1,0,1,1,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,1,1,0,0,0,0,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,1,1,1,1,1,0,0,0,0,1,1,0,0,0,0,0,1,1,1,1,0,0,0,0,1,1,1,1,0,0,0,0,0,0,1,1,1,0,0,1,1,1,1,1,1,0,0,0,0,1,1,1,0,0,0,1,1,1,1,1,1,0,0,0,1,1,1,1,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,1,1,1,1,0,0,0,0,1,1,1,1,1,0,0,0,0,1,1,0,0,0,0,1,1,1,1,1,1,0,0,0,0,1,1,1,1,0,0,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,0,0,0,1,1,1,1,0,0,1,1,0,0,1,1,0,0,0,1,1,1,1,0,0,0,0,0,0,1,1,1,1,0,1,1,1,0,0,1,1,0,1,1,1,1,0,0,0,0,1,1,0,0,0,1,1,0,1,1,0,0,0,1,1,0,0,0,1,1,1,0,0,0,1,1,1,1,1,1,0,0,0,1,1,1,1,0,0,0,1,1,1,1,1,1,0,0,0,1,1,1,1,0,0,0,1,1,1,1,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,0,1,1,0,1,1,0,0,0,1,1,0,1,1,0,0,1,1,0,0,1,1,1,1,1,1,1,0,0,1,1,1,1,0,0,0,1,1,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,1,1,0,0,1,1,1,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,1,1,0,0,0,1,1,1,0,0,0,0,0,0,1,1,1,0,1,1,0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,1,1,0,1,1,0,0,0,1,1,0,1,1,0,0,0,1,1,1,1,1,0,0,1,1,0,0,0,1,1,0,0,1,1,0,1,1,0,0,0,1,1,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,1,1,0,0,0,0,0,1,1,0,0,1,1,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,1,1,0,0,0,1,1,0,0,1,1,1,0,0,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,0,0,1,1,1,1,0,0,1,1,0,0,0,0,0,0,0,1,1,0,0,0,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,0,0,1,1,0,0,0,0,0,0,1,1,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,1,1,0,0,1,1,0,0,1,1,0,0,0,1,1,0,0,1,1,1,1,0,0,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,1,1,0,0,0,1,1,0,0,0,1,0,0,1,1,0,0,0,1,0,0,1,1,0,0,1,1,0,1,1,0,0,1,1,0,0,0,0,1,1,0,0,0,0,0,0,0,0,1,1,0,0,0,1,1,0,0,1,1,0,0,1,1,0,0,0,0,0,1,1,1,0,1,1,1,0,1,1,1,0,0,1,1,0,0,1,1,0,1,1,0,0,0,1,1,0,0,1,1,0,1,1,0,0,1,1,0,0,0,1,1,0,0,1,1,0,1,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,0,1,1,0,1,1,0,0,0,1,1,0,1,1,0,0,1,1,0,0,1,1,0,0,0,1,1,0,0,1,1,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,0,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,1,1,0,0,0,0,0,1,1,0,0,0,0,1,1,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,1,1,0,1,1,0,0,1,1,1,1,1,1,1,0,1,1,0,0,0,0,0,0,1,1,0,0,1,1,0,0,0,0,1,1,1,0,0,0,1,1,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,1,1,1,1,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,1,1,0,0,1,1,1,0,0,0,1,1,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,1,1,0,0,0,1,1,0,1,1,0,0,1,1,1,1,1,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,0,0,1,1,0,0,0,0,0,0,1,1,0,0,0,0,0,1,1,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,1,1,0,0,0,0,0,0,0,1,1,0,0,1,1,0,1,1,1,1,0,1,1,0,0,1,1,0,0,0,1,1,0,0,1,1,0,1,1,0,0,0,0,0,0,0,1,1,0,0,1,1,0,0,1,1,0,1,0,0,0,0,1,1,0,1,0,0,0,1,1,0,0,0,0,0,0,1,1,0,0,1,1,0,0,0,0,1,1,0,0,0,0,0,0,0,0,1,1,0,0,0,1,1,0,1,1,0,0,0,1,1,0,0,0,0,0,1,1,1,1,1,1,1,0,1,1,1,1,0,1,1,0,1,1,0,0,0,1,1,0,0,1,1,0,0,1,1,0,1,1,0,0,1,1,0,0,0,1,1,0,0,1,1,0,1,1,1,0,0,0,0,0,0,0,1,1,0,0,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,0,1,1,0,0,1,1,0,1,1,0,0,1,1,0,0,1,1,0,0,1,0,0,0,1,1,0,0,0,1,1,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,1,1,0,0,0,0,1,1,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,1,1,1,1,0,0,0,0,1,1,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,1,1,0,0,0,1,1,1,1,0,0,0,0,1,1,0,0,0,0,0,0,1,1,1,0,1,1,0,0,1,1,0,1,1,0,0,0,1,1,1,0,0,0,0,0,0,0,0,1,1,0,0,0,1,1,0,0,1,1,0,0,0,1,1,0,0,0,0,1,1,0,0,1,1,0,0,1,1,1,1,1,0,0,0,0,1,1,1,1,0,0,0,1,1,0,1,1,1,0,0,0,1,1,1,0,1,1,0,1,1,0,1,1,1,0,0,0,1,1,1,1,1,0,0,0,1,1,1,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,0,1,1,0,1,1,0,0,0,1,1,0,1,1,0,0,1,1,0,0,1,1,1,1,1,1,0,0,0,0,1,1,0,0,0,0,0,0,0,1,1,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,1,1,0,0,0,1,1,1,1,0,0,0,0,0,0,1,1,0,0,0,0,1,1,1,0,1,1,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,1,1,0,1,1,1,1,0,0,0,1,1,0,0,0,0,0,0,1,1,1,0,0,0,0,0,1,1,1,0,0,0,1,1,0,0,1,1,0,0,0,0,0,0,1,1,0,0,1,1,1,1,1,0,0,0,0,0,0,1,1,0,0,0,0,1,1,1,1,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,1,1,0,0,0,1,1,0,1,1,1,1,0,1,1,0,0,1,1,0,0,0,1,1,1,1,1,0,0,1,1,0,0,0,0,0,0,0,1,1,0,0,1,1,0,0,1,1,1,1,0,0,0,0,1,1,1,1,0,0,0,1,1,0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,1,1,0,0,0,0,0,0,0,0,1,1,0,0,0,1,1,1,1,0,0,0,0,1,1,0,0,0,0,0,1,1,1,1,1,1,1,0,1,1,0,1,1,1,1,0,1,1,0,0,0,1,1,0,0,1,1,1,1,1,0,0,1,1,0,0,1,1,0,0,0,1,1,1,1,1,0,0,0,1,1,1,0,0,0,0,0,0,1,1,0,0,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,1,0,1,1,0,0,0,1,1,1,0,0,0,0,1,1,1,1,0,0,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,1,1,0,0,0,1,1,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,1,1,1,1,1,0,0,1,1,0,0,1,1,0,0,0,1,1,1,1,1,0,0,1,1,0,0,1,1,0,0,1,1,1,1,0,0,0,0,1,1,0,0,1,1,0,0,0,1,1,1,0,1,1,0,0,0,1,1,0,0,0,0,0,0,0,0,1,1,0,0,0,1,1,0,1,1,0,0,0,0,1,1,0,0,0,0,1,1,1,1,1,1,1,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,0,1,1,0,0,1,1,0,1,1,0,0,1,1,0,0,0,1,1,1,0,1,1,0,1,1,0,0,0,0,0,0,0,0,1,1,0,0,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,1,0,1,1,0,0,1,1,0,1,1,0,0,1,1,0,0,1,1,0,0,1,0,0,1,1,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,1,1,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,1,1,1,1,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,1,1,1,1,0,1,1,0,0,0,1,1,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,1,1,0,0,1,1,1,1,1,1,1,0,0,0,0,0,1,1,0,0,1,1,0,0,1,1,0,0,0,0,1,1,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,1,1,0,0,0,0,1,1,0,1,1,1,1,0,1,1,1,1,1,1,0,0,0,1,1,0,0,1,1,0,1,1,0,0,0,0,0,0,0,1,1,0,0,1,1,0,0,1,1,0,1,0,0,0,0,1,1,0,1,0,0,0,1,1,0,0,1,1,1,0,1,1,0,0,1,1,0,0,0,0,1,1,0,0,0,0,1,1,0,0,1,1,0,0,0,1,1,0,1,1,0,0,0,1,1,0,0,0,1,0,1,1,0,1,0,1,1,0,1,1,0,0,1,1,1,0,1,1,0,0,0,1,1,0,0,1,1,0,0,0,0,0,1,1,0,1,1,1,0,0,0,1,1,0,1,1,0,0,0,0,0,1,1,1,0,0,0,0,1,1,0,0,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,1,1,1,1,1,0,0,0,1,1,1,0,0,0,0,0,1,1,0,0,0,0,0,0,1,1,0,0,1,0,0,1,1,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,1,1,0,0,1,1,0,1,1,0,0,0,0,0,0,1,1,0,0,1,1,0,0,1,1,1,1,1,1,0,0,0,1,1,0,0,0,0,0,1,1,0,0,1,1,0,0,0,1,1,0,0,1,1,0,0,0,1,1,0,0,0,0,0,0,0,0,1,1,0,0,0,1,1,1,1,0,0,0,0,0,1,1,0,0,0,0,1,1,1,1,1,1,1,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,0,1,1,0,0,1,1,0,1,1,0,0,1,1,0,0,0,1,1,0,0,1,1,0,0,1,1,1,1,0,0,0,0,0,1,1,0,0,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,1,1,1,1,1,0,0,0,1,1,1,0,0,0,1,1,0,0,1,1,0,0,0,0,1,1,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,1,1,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,1,1,0,0,1,1,1,1,1,0,0,0,0,1,1,0,0,1,1,0,1,1,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,1,1,0,0,0,0,0,1,1,0,0,1,1,0,0,0,1,1,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,0,0,1,1,1,0,0,1,1,0,0,0,1,1,0,0,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,0,0,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,0,0,1,1,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0,1,1,0,0,0,0,0,1,1,0,0,0,0,0,0,1,1,0,0,0,0,0,0,1,1,0,0,0,0,1,1,1,1,1,1,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,1,1,0,0,1,1,0,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,1,1,0,0,0,1,1,0,0,0,1,0,0,1,1,0,0,0,0,0,0,1,1,0,0,1,1,0,1,1,0,0,1,1,0,0,0,0,1,1,0,0,0,0,1,1,0,0,1,1,0,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,1,1,0,0,0,1,1,0,1,1,0,0,0,1,1,0,0,1,1,0,1,1,0,0,0,1,1,0,0,0,0,0,0,1,1,1,1,0,0,0,0,1,1,0,0,1,1,0,1,1,0,0,1,1,0,0,0,0,1,1,0,0,0,0,1,1,0,0,1,1,0,0,0,1,1,1,1,0,0,0,1,1,1,0,1,1,1,0,0,1,1,0,1,1,0,0,0,0,1,1,0,0,0,0,0,1,1,0,0,1,1,0,0,1,1,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,1,1,0,0,0,1,1,0,0,1,1,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,1,1,1,1,1,0,0,0,1,1,0,0,1,1,0,0,0,1,1,0,0,0,0,1,1,0,0,1,1,0,0,0,1,1,0,1,1,0,0,0,0,1,1,0,0,0,0,1,1,0,1,0,1,1,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,0,1,1,1,1,1,0,0,0,1,1,1,1,1,0,0,0,1,1,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,1,1,0,1,0,0,1,1,0,0,1,1,0,0,0,1,1,1,1,0,0,0,1,1,1,1,1,1,1,0,0,1,1,0,1,1,0,0,0,1,1,1,1,1,0,0,0,1,1,0,0,1,0,0,0,0,1,1,0,0,0,0,0,0,0,1,1,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,1,1,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,1,1,0,0,1,1,1,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,1,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,1,1,1,1,1,1,0,0,1,1,1,1,1,1,0,0,0,1,1,1,1,0,0,0,0,0,0,1,1,1,1,0,0,1,1,1,1,0,0,0,0,1,1,1,1,0,0,0,0,0,1,1,0,0,0,0,0,1,1,1,1,0,0,0,0,1,1,1,0,0,0,0,0,0,1,1,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,1,1,0,0,0,0,0,1,1,1,1,0,0,0,1,1,0,0,1,1,0,0,1,1,1,1,1,1,0,0,0,0,1,1,1,1,0,0,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,0,1,1,1,1,0,0,0,0,0,0,1,1,1,1,1,0,1,1,0,0,1,1,0,0,0,1,1,1,1,0,0,0,0,1,1,1,1,0,0,0,1,1,1,0,0,1,1,0,1,1,1,1,1,1,1,0,1,1,0,0,0,1,1,0,1,1,0,0,0,1,1,0,0,0,1,1,1,0,0,0,1,1,1,1,0,0,0,0,0,0,0,1,1,1,0,0,1,1,1,0,0,1,1,0,0,1,1,1,1,0,0,0,0,1,1,1,1,0,0,0,1,1,1,1,1,1,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,1,1,0,1,1,0,0,0,1,1,0,0,1,1,1,1,0,0,0,1,1,1,1,1,1,1,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,1,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,1,1,0,1,1,0,1,1,1,0,0,0,1,1,1,1,0,0,0,0,1,1,1,0,1,1,0,0,1,1,1,1,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,1,1,0,0,1,1,1,0,0,1,1,0,0,1,1,1,1,0,0,0,1,1,0,0,1,1,0,0,1,1,1,0,0,1,1,0,0,1,1,1,1,0,0,0,1,1,0,0,0,1,1,0,1,1,0,0,1,1,0,0,0,1,1,1,1,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,1,1,0,0,1,1,1,1,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,1,1,0,0,0,0,1,1,1,0,1,1,0,0,0,1,1,0,0,0,0,0,1,1,0,1,1,0,0,1,1,0,0,0,1,1,0,0,0,0,0,1,1,0,0,1,1,1,1,1,1,0,0,0,0,0,1,1,1,0,0,0,0,0,1,1,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};

char src[] = /* xorshift32 random noise generator */
"MOV A, 1       \n"
"MOV B, 65535   \n"
"MOV C, 1       \n"
"MOV D, 13      \n"
"MOV E, 17      \n"
"MOV F, 5       \n"
"MOV H, 256     \n"
"MOV I, 142336  \n" /* 65536+320*240 */
"SHL G, A, D    \n"
"XOR A, A, G    \n"
"SHR G, A, E    \n"
"XOR A, A, G    \n"
"SHL G, A, F    \n"
"XOR A, A, G    \n"
"ADD B, B, C    \n"
"STO B, A       \n"
"JML B, I, 48   \n"
"JMP 6          \n";

/* alternative C standard library implementations */
int alt_strlen(char *s) {
  int i = 0;
  while(s[i]!=0)
    i++;
  return i;
}

int alt_strcpy(char *s, char *t) {
  int i = 0;
  while(t[i]!=0)
    s[i] = t[i++];
  s[i+1] = 0;
}

int alt_isdigit(int c) {
  return (unsigned int)c-'0' < 10;
}

int alt_isspace(int c) {
  return c == ' ';
}

int alt_atoi(char *s) {
  int n = 0, neg = 0;
  while(alt_isspace(*s)) s++;
  if(*s=='-') neg = 1;
  if(*s=='+') s++;
  while(alt_isdigit(*s))
    n = 10*n - (*s++ - '0');
  return neg ? n : -n;
}

int alt_strcmp(char *l, char *r) {
  while(*l==*r && *l) {
    r++;
    l++;
  }
  return *(unsigned char *)l - *(unsigned char *)r;
}

#define BITOP(a,b,op) ((a)[(int)(b)/(8*sizeof *(a))] op (int)1<<((int)(b)%(8*sizeof *(a))))

int alt_strspn(char *s, char *c) {
  char *a = s;
  int byteset[32/sizeof(size_t)] = {0};

  if(!c[0]) return 0;
  if(!c[1]) {
    for(; *s == *c; s++);
    return s-a;
  }
  while(*c && BITOP(byteset, *(unsigned char *)c, |=))
    c++;
  while(*s && BITOP(byteset, *(unsigned char *)s, &))
    s++;
  return s-a;
}
/* alternative C standard library implementations */

int extvals(char *s, char *a, char *b, char *c, char *d) {
  int i = 0, j = 0;
  while(s[i]!=' ') a[j++] = s[i++];
  a[j] = 0; i++; j = 0;
  while(s[i]!=' ') b[j++] = s[i++];
  b[j] = 0; i++; j = 0;
  while(s[i]!=' ') c[j++] = s[i++];
  c[j] = 0; i++; j = 0;
  while(s[i]!=' ') d[j++] = s[i++];
  d[j] = 0;
}

int assemble() {
  FILE *out = fopen("dst.bin", "wb");
  unsigned char op[64], a[64], b[64], c[64], nline[80];
  unsigned char *lines[80];
  int i = 0, j, k, l = 0, line = 0, nlines = 0;

  /* read source code from a string */
  while(i<alt_strlen(src)) {
    j = 0;
    while(src[i]!='\n')
      nline[j++] = src[i++];
    i++;
    lines[nlines] = malloc(80);
    alt_strcpy(lines[nlines++], nline);
  }

  /* read source code from a file */
  /*
  FILE *inp = fopen("src.asm", "r");
  while(fgets(nline, 80, inp)!=NULL) {
    lines[nlines] = malloc(80);
    strcpy(lines[nlines++], nline);
  }
  fclose(inp);
  nlines--;
  */

  /* assemble into a binary file */
  while(l<nlines) {
    //sscanf(lines[l], "%s %s %s %s", op, a, b, c);
    extvals(lines[l], op, a, b, c);
    if(alt_strspn(c, "0123456789") == strlen(c)) j = alt_atoi(c);
    if(alt_strspn(b, "0123456789") == strlen(b)) j = alt_atoi(b);
    if(alt_strspn(a, "0123456789") == strlen(a)) j = alt_atoi(a);
    l = l + 1;

    if(!alt_strcmp(op, "JMP")) {
      fprintf(out, "%c", JMP);
      fprintf(out, "%c", (j&0b11111111000000000000000000000000)>>24);
      fprintf(out, "%c", (j&0b00000000111111110000000000000000)>>16);
      fprintf(out, "%c", (j&0b00000000000000001111111100000000)>>8);
      fprintf(out, "%c",  j&0b00000000000000000000000011111111);
      printf("%.10d\tJMP %d\n", line, j);
      line += 5;
    }
    if(!alt_strcmp(op, "JML")) {
      fprintf(out, "%c", JML);
      fprintf(out, "%c", a[0] - 'A');
      fprintf(out, "%c", b[0] - 'A');
      fprintf(out, "%c", (j&0b11111111000000000000000000000000)>>24);
      fprintf(out, "%c", (j&0b00000000111111110000000000000000)>>16);
      fprintf(out, "%c", (j&0b00000000000000001111111100000000)>>8);
      fprintf(out, "%c",  j&0b00000000000000000000000011111111);
      printf("%.10d\tJML %c, %c, %d\n", line, a[0], b[0], j);
      line = line + 7;
    }
    if(!alt_strcmp(op, "MOV")) {
      fprintf(out, "%c", MOV);
      fprintf(out, "%c", a[0] - 'A');
      fprintf(out, "%c", (j&0b11111111000000000000000000000000)>>24);
      fprintf(out, "%c", (j&0b00000000111111110000000000000000)>>16);
      fprintf(out, "%c", (j&0b00000000000000001111111100000000)>>8);
      fprintf(out, "%c",  j&0b00000000000000000000000011111111);
      printf("%.10d\tMOV %c, %d\n", line, a[0], j);
      line = line + 6;
    }
    if(!alt_strcmp(op, "LDA")) {
      fprintf(out, "%c", LDA);
      fprintf(out, "%c", a[0] - 'A');
      fprintf(out, "%c", b[0] - 'A');
      printf("%.10d\tLDA %c, %c\n", line, a[0], b[0]);
      line = line + 3;
    }
    if(!alt_strcmp(op, "STO")) {
      fprintf(out, "%c", STO);
      fprintf(out, "%c", a[0] - 'A');
      fprintf(out, "%c", b[0] - 'A');
      printf("%.10d\tSTO %c, %c\n", line, a[0], b[0]);
      line = line + 3;
    }
    if(!alt_strcmp(op, "SHL")) {
      fprintf(out, "%c", SHL);
      fprintf(out, "%c", a[0] - 'A');
      fprintf(out, "%c", b[0] - 'A');
      fprintf(out, "%c", c[0] - 'A');
      printf("%.10d\tSHL %c, %c, %c\n", line, a[0], b[0], c[0]);
      line = line + 4;
    }
    if(!alt_strcmp(op, "SHR")) {
      fprintf(out, "%c", SHR);
      fprintf(out, "%c", a[0] - 'A');
      fprintf(out, "%c", b[0] - 'A');
      fprintf(out, "%c", c[0] - 'A');
      printf("%.10d\tSHR %c, %c, %c\n", line, a[0], b[0], c[0]);
      line = line + 4;
    }
    if(!alt_strcmp(op, "NOT")) {
      fprintf(out, "%c", NOT);
      fprintf(out, "%c", a[0] - 'A');
      fprintf(out, "%c", b[0] - 'A');
      printf("%.10d\tNOT %c, %c\n", line, a[0], b[0]);
      line = line + 3;
    }
    if(!alt_strcmp(op, "AND")) {
	  fprintf(out, "%c", AND);
      fprintf(out, "%c", a[0] - 'A');
      fprintf(out, "%c", b[0] - 'A');
      fprintf(out, "%c", c[0] - 'A');
      printf("%.10d\tAND %c, %c, %c\n", line, a[0], b[0], c[0]);
      line = line + 4;
    }
    if(!alt_strcmp(op, "IOR")) {
      fprintf(out, "%c", IOR);
      fprintf(out, "%c", a[0] - 'A');
      fprintf(out, "%c", b[0] - 'A');
      fprintf(out, "%c", c[0] - 'A');
      printf("%.10d\tOR  %c, %c, %c\n", line, a[0], b[0], c[0]);
      line = line + 4;
    }
    if(!alt_strcmp(op, "XOR")) {
      fprintf(out, "%c", XOR);
      fprintf(out, "%c", a[0] - 'A');
      fprintf(out, "%c", b[0] - 'A');
      fprintf(out, "%c", c[0] - 'A');
      printf("%.10d\tXOR %c, %c, %c\n", line, a[0], b[0], c[0]);
      line = line + 4;
    }
    if(!alt_strcmp(op, "ADD")) {
      fprintf(out, "%c", ADD);
      fprintf(out, "%c", a[0] - 'A');
      fprintf(out, "%c", b[0] - 'A');
      fprintf(out, "%c", c[0] - 'A');
      printf("%.10d\tADD %c, %c, %c\n", line, a[0], b[0], c[0]);
      line = line + 4;
    }
  }
  fflush(out);
  fclose(out);

  l = 0;
  while(l<nlines) {
    free(lines[l]);
    l++;
  }
}

int main(int argc, char* args[]) {
  unsigned char R, G, B;
  char *mem = malloc(4*65536*sizeof(char)); /* 256 kB */
  int reg[128], pc, data, *p, t = 1, len, OP, a, b, c, i, j, k;
  SDL_Event event;
  SDL_Window *window;
  SDL_Surface *surface;

  assemble();

  SDL_Init(SDL_INIT_VIDEO);
  window = SDL_CreateWindow("CCPU", SDL_WINDOWPOS_CENTERED, SDL_WINDOWPOS_CENTERED, 640, 480, 0);
  surface = SDL_GetWindowSurface(window);

  for(pc=0; pc<128; pc++) reg[pc] = 0;
  for(pc=0; pc<4*65536; pc++) mem[pc] = 0;

  FILE *f = fopen("dst.bin", "rb");
  fseek(f, 0, SEEK_END);
  len = ftell(f);
  rewind(f);
  fread(mem, 1, len, f);
  fclose(f);

  pc = 0;
  while(t++) {

  	OP = mem[pc];
  	a = mem[pc+1];
  	b = mem[pc+2];
  	c = mem[pc+3];
  	i = mem[pc+4];
  	j = mem[pc+5];
  	k = mem[pc+6];

    /* JMP */
    if(OP==JMP) {
      pc = ((unsigned char)(a)<<24)+((unsigned char)(b)<<16)+((unsigned char)(c)<<8)+(unsigned char)(i);
#ifdef DEBUG
      printf("JMP %d\n", data);
#endif
    }

    /* JML A, B, addr32 */
    if(OP==JML) {
      data = ((unsigned char)(c)<<24)+((unsigned char)(i)<<16)+((unsigned char)(j)<<8)+(unsigned char)(k);
      if(reg[a]<reg[b])
		pc = data;
      else
		pc = pc + 7;
#ifdef DEBUG
      printf("JML %c, %c, %d\n", a+'A', b+'A', data);
#endif
    }

    /* MOV A, val */
    if(OP==MOV) {
      data = (b<<24)+((unsigned char)(c)<<16)+((unsigned char)(i)<<8)+(unsigned char)(j);
      reg[a] = data;
      pc = pc + 6;
#ifdef DEBUG
      printf("MOV %c, %d\n", a+'A', reg[a]);
#endif
    }

    /* LDA A, B (A = MEM[B]) */
    if(OP==LDA) {
      reg[a] = mem[reg[b]];
      pc = pc + 3;
#ifdef DEBUG
      printf("LDA %c, %c\n", a+'A', b+'A');
#endif
    }

    /* STO A, B (MEM[A] = B) */
    if(OP==STO) {
      mem[reg[a]] = reg[b];
      pc = pc + 3;
#ifdef DEBUG
      printf("STO %c, %c (MEM[%d] = %d)\n", a+'A', b+'A', reg[a], reg[b]);
#endif
    }

    /* SHL A, B, C */
    if(OP==SHL) {
      reg[a] = reg[b] << reg[c];
      pc = pc + 4;
#ifdef DEBUG
      printf("SHL %c, %c, %c\n", a+'A', b+'A', c+'A');
#endif
    }

    /* SHR A, B, C */
    if(OP==SHR) {
      reg[a] = reg[b] >> reg[c];
      pc = pc + 4;
#ifdef DEBUG
      printf("SHR %c, %c, %c\n", a+'A', b+'A', c+'A');
#endif
    }

    /* NOT A, B */
    if(OP==NOT) {
      reg[a] = ~reg[b];
      pc = pc + 4;
#ifdef DEBUG
      printf("NOT %c, %c\n", a+'A', b+'A');
#endif
    }

    /* AND A, B, C */
    if(OP==AND) {
      reg[a] = reg[b] & reg[c];
      pc = pc + 4;
#ifdef DEBUG
      printf("AND %c, %c, %c\n", a+'A', b+'A', c+'A');
#endif
    }

    /* IOR A, B, C */
    if(OP==IOR) {
      reg[a] = reg[b] | reg[c];
      pc = pc + 4;
#ifdef DEBUG
      printf("IOR %c, %c, %c\n", a+'A', b+'A', c+'A');
#endif
    }

    /* XOR A, B, C */
    if(OP==XOR) {
      reg[a] = reg[b] ^ reg[c];
      pc = pc + 4;
#ifdef DEBUG
      printf("XOR %c, %c, %c\n", a+'A', b+'A', c+'A');
#endif
    }

    /* ADD A, B, C */
    if(OP==ADD) {
      reg[a] = reg[b] + reg[c];
      pc = pc + 4;
#ifdef DEBUG
      printf("ADD %c, %c, %c\n", a+'A', b+'A', c+'A');
#endif
    }

    /* draw from MEM[65536:65536+320*240] which is treated as RGB222 */
	if(!(t%12800)) {
      for(j=0; j<480; j++)
      	for(i=0; i<640; i++) {
      	  p = (int *)surface->pixels+(i+j*640);
		  R = 85* (mem[65536+(i>>1)+(j>>1)*320]&0b00000011);
		  G = 85*((mem[65536+(i>>1)+(j>>1)*320]&0b00001100)>>2);
		  B = 85*((mem[65536+(i>>1)+(j>>1)*320]&0b00110000)>>4);
		  *p = (R<<16) + (G<<8) + B;
        }
      SDL_UpdateWindowSurface(window);
    }
    if(SDL_PollEvent(&event) && event.type == SDL_QUIT) break;

  }
  free(mem);
  SDL_DestroyWindow(window);
  SDL_Quit();
}
